name: Send a newsletter.

on:
  schedule:
    # Run at midnight UTC on Monday
    # Use https://crontab.guru/
    - cron: "0 0 * * MON"

  repository_dispatch:
    types: manual-trigger

jobs:
  newsletter:
    name: newsletter
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Decrypt .env.gpg => .env
        env:
          SYMMETRIC_KEY: ${{ secrets.GPG_KEY }}
        run: |
          echo $SYMMETRIC_KEY > key
          gpg2 --import key
          gpg2 --quiet --batch --yes --decrypt --output=.env .env.gpg

      - name: Run the process
        run: |
          UNTIL=$(echo date +%Y-%m-%d)
          SINCE=$(date -d "$date -7 days" +"%Y-%m-%d")
          SINCE="echo ${SINCE}"
          export $(cat .env | xargs) && pipenv run python main.py --since $SINCE --until $UNTIL

      - name: Encrypt .env => .env.gpg
        env:
          SYMMETRIC_KEY: ${{ secrets.GPG_KEY }}
        run: gpg2 --symmetric --batch .env

      - name: Push .env.gpg
        run: |
          git commit -am 'Updating .env.gpg'
          git push
